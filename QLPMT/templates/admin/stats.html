{% extends 'admin/master.html' %}

{% block body %}
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
            <h3>BÁO CÁO DOANH THU THÁNG {{ month }}</h3>
        </div>

        <div class="card-body">
            <form method="get" class="mb-4">
                <label for="monthSelect">Chọn tháng:</label>
                <select name="month" id="monthSelect" class="form-control w-25 d-inline">
                    {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if month == m %}selected{% endif %}>Tháng {{ m }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Xem báo cáo</button>
            </form>

            <h4 class="text-center mb-3 fw-bold">TỔNG DOANH THU THÁNG {{ month }}:
                <span class="text-success">{{ total_revenue | int | default(0) }} VND</span>
            </h4>

            <div class="row">
                <div class="col-md-6">
                    <h4>Bảng thống kê doanh thu</h4>
                    <table class="table table-striped">
                        <thead class="table-dark">
    <tr>
        <th>STT</th>
        <th>Ngày</th>
        <th>Số bệnh nhân</th>
        <th>Doanh thu (VND)</th>
        <th>Tỷ lệ doanh thu (%)</th>  <!-- ✅ Thêm cột tỷ lệ -->
    </tr>
</thead>
<tbody>
    {% if receipts %}
        {% for receipt in receipts %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ receipt.date }}</td>
            <td>{{ receipt.patient_count }}</td>
            <td class="fw-bold text-success">
                {{ receipt.total_revenue | int | default(0) }} VND
            </td>
            <td class="fw-bold text-info">
                {{ receipt.percentage | round(2) }}%  <!-- ✅ Hiển thị phần trăm, làm tròn 2 chữ số -->
            </td>
        </tr>
        {% endfor %}
    {% else %}
        <tr>
            <td colspan="5" class="text-center text-danger">Không có dữ liệu</td>
        </tr>
    {% endif %}
</tbody>
                    </table>
                </div>

                <div class="col-md-6">
                    <h4>Biểu đồ doanh thu theo ngày</h4>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let labels = [];
    let patientCounts = [];
    let revenueData = [];

    {% for receipt in receipts %}
        labels.push('{{ receipt.date }}');
        patientCounts.push({{ receipt.patient_count }});
        revenueData.push({{ receipt.total_revenue }});
    {% endfor %}

    window.onload = function(){
        const ctx = document.getElementById('revenueChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số bệnh nhân',
                    data: patientCounts,
                    borderWidth: 1,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)'
                }, {
                    label: 'Doanh thu (VND)',
                    data: revenueData,
                    borderWidth: 1,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>
{% endblock %}